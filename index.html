<!DOCTYPE html>
<html lang="en">
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
        <title>Tower Defense</title>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/phaser/2.0.6/phaser.min.js"></script>
        <script type="text/javascript" src="https://s3.amazonaws.com/easystar/easystar-0.1.8.min.js"></script>
        <script type="text/javascript" src="bin/phaser_pathfinding-0.2.0.min.js"></script>

        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

        <script type="text/javascript" src="bin/phaser_pathfinding-0.2.0.js"></script>


        <style>
            *{
                margin : 0;
            }
        </style>
    </head>
    <body>

    </body>
    <script type="text/javascript">

        var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'gameContainer', {preload: preload, create: create, update: update, render: render});
        var tileSquare = 32;
        var map, layer;
        var pathForbiden = ["012", "112", "212", "312", "412", "512", "511", "510", "59", "58", "68", "78", "88", "98", "108", "118", "128", "138", "139", "1310", "1311", "1312", "1313", "1314", "1315", "1316", "1416", "1516", "1616", "1716", "1816", "1916", "2016", "2116", "2115", "2114", "2113", "2213", "2313", "2413", "2513"]
        var path = [{x: 0, y: 12}, {x: 1, y: 12}, {x: 2, y: 12}, {x: 3, y: 12}, {x: 4, y: 12}, {x: 5, y: 12}, {x: 5, y: 11}, {x: 5, y: 10}, {x: 5, y: 9}, {x: 5, y: 8}, {x: 6, y: 8}, {x: 7, y: 8}, {x: 8, y: 8}, {x: 9, y: 8}, {x: 10, y: 8}, {x: 11, y: 8}, {x: 12, y: 8}, {x: 13, y: 8},
            {x: 13, y: 9}, {x: 13, y: 10}, {x: 13, y: 11}, {x: 13, y: 12}, {x: 13, y: 13}, {x: 13, y: 14}, {x: 13, y: 15}, {x: 13, y: 16}, {x: 14, y: 16}, {x: 15, y: 16}, {x: 16, y: 16}, {x: 17, y: 16}, {x: 18, y: 16}, {x: 19, y: 16}, {x: 20, y: 16}, {x: 21, y: 16}, {x: 21, y: 15},
            {x: 21, y: 14}, {x: 21, y: 13}, {x: 22, y: 13}, {x: 23, y: 13}, {x: 24, y: 13}, {x: 25, y: 13}];

        var car, car2;
        var towers

        function preload() {

            game.load.tilemap('desert', 'assets/tower-defense.json', null, Phaser.Tilemap.TILED_JSON);
            game.load.image('tiles', 'assets/tmw_desert_spacing.png');
            game.load.image('car', 'assets/car90.png');
            game.load.image('tower', 'assets/tower-32.png');
        }


        function create() {
            /**
             * Init map
             */
            map = game.add.tilemap('desert');
            map.addTilesetImage('Desert', 'tiles');
            layer = map.createLayer('Ground');
            layer.resizeWorld();
            game.input.onDown.add(listener, this);
            /*
             * Tower
             */
            towers = game.add.group();
            /*
             * Enemy
             */
            car = game.add.sprite(path[0].x * tileSquare, path[0].y * tileSquare, 'car');
            car.anchor.setTo(0.5, 0.5);
            car.speed = 5;
            car.speedX = 0;
            car.speedY = 0;
            car.curTile = 0;
            car.debug = true;
            nextTile(car);

            car2 = game.add.sprite(path[0].x * tileSquare, path[0].y * tileSquare, 'car');
            car2.anchor.setTo(0.5, 0.5);
            car2.speed = 2;
            car2.speedX = 0;
            car2.speedY = 0;
            car2.curTile = 0;
            car2.debug = true;
            nextTile(car2);

        }

        function moveElmt(elmt) {

            elmt.x += elmt.speedX;
            elmt.y += elmt.speedY;

            if (elmt.speedX > 0 && elmt.x >= elmt.next_positX) {
                elmt.x = elmt.next_positX;
                nextTile(elmt);
            }
            else if (elmt.speedX < 0 && elmt.x <= elmt.next_positX) {
                elmt.x = elmt.next_positX;
                nextTile(elmt);
            }
            else if (elmt.speedY > 0 && elmt.y >= elmt.next_positY) {
                elmt.y = elmt.next_positY;
                nextTile(elmt);
            }
            else if (elmt.speedY < 0 && elmt.y <= elmt.next_positY) {
                elmt.y = elmt.next_positY;
                nextTile(elmt);
            }



        }

        function nextTile(elmt) {
            elmt.curTile++;
            elmt.next_positX = parseInt(path[elmt.curTile].x * tileSquare);
            elmt.next_positY = parseInt(path[elmt.curTile].y * tileSquare);
            // on check le sens gauche/droite
            if (elmt.next_positX > elmt.x) {
                elmt.speedX = elmt.speed;
                elmt.angle = 0;
            } else if (elmt.next_positX < elmt.x) {
                elmt.speedX = -elmt.speed;
                elmt.angle = 180;
            } else {
                elmt.speedX = 0;
            }
            // on check le sens haut/bas
            if (elmt.next_positY > elmt.y) {
                elmt.speedY = elmt.speed;
                elmt.angle = 90;
            } else if (elmt.next_positY < elmt.y) {
                elmt.speedY = -elmt.speed;
                elmt.angle = -90;
            } else {
                elmt.speedY = 0;
            }
        }

        function render() {

        }

        function update() {

            moveElmt(car);
            moveElmt(car2);
        }


        function listener(pointer) {

            var tileworldX = pointer.worldX - (pointer.worldX % tileSquare);
            var tileworldY = pointer.worldY - (pointer.worldY % tileSquare);
            var tileX = Math.floor(pointer.worldX / tileSquare);
            var tileY = Math.floor(pointer.worldY / tileSquare);

            var index = String(tileX + "" + tileY)
            if ($.inArray(index, pathForbiden) == -1) {
                towers.create(tileworldX, tileworldY, 'tower')
            }
        }


    </script>
</html>